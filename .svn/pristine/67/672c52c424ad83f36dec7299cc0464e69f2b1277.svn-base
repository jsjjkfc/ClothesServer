package com.twocore.controller;

import java.util.HashMap;
import java.util.Map;

import javax.annotation.Resource;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import me.chanjar.weixin.common.exception.WxErrorException;
import me.chanjar.weixin.mp.api.WxMpServiceImpl;
import me.chanjar.weixin.mp.bean.result.WxMpOAuth2AccessToken;
import me.chanjar.weixin.mp.bean.result.WxMpUser;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Scope;
import org.springframework.stereotype.Controller;
import org.springframework.stereotype.Service;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.servlet.ModelAndView;

import com.twocore.model.UserModel;
import com.twocore.service.IUserService;

@Scope("prototype")
// singleton为单例模式
@Controller
@RequestMapping("/account")
public class AccountComtroller {
	@Resource(name = "userService")
	IUserService userService;
	@Autowired
	WxMpServiceImpl wxMpServiceImpl;
	@RequestMapping(value = "/login", method = RequestMethod.POST)
	public  ModelAndView login(HttpServletRequest request,
			HttpServletResponse response, HttpSession httpSession) {
		String uname = request.getParameter("uname");
		String upassword = request.getParameter("upassword");
		if(uname!=null&&upassword!=null){
			UserModel model = userService.queryByName(uname);
			if (model != null) {
				String password = model.password;
				if (password.equals(upassword)) {//认证成功
					httpSession.setAttribute("user", model);//存储用户所有信息
					Map<String, Object> data = new HashMap<String, Object>();
					data.put("user", model);
					httpSession.setMaxInactiveInterval(-1);// 设置session销毁时间 ,此处设定为永久
					return new ModelAndView("redirect:/index.jsp",data);
				}else{//密码错误的情况
					Map<String, Object> data = new HashMap<String, Object>();
					data.put("errorMsg", "密码错误!");
					
					return new ModelAndView("forward:/login.jsp",data);
				}
			}else{//用户名找不到的情况
				System.out.println("无此用户");
				Map<String, Object> data = new HashMap<String, Object>();
				data.put("errorMsg", "无此用户!");
				return new ModelAndView("redirect:/index.jsp",data);
			}
		}else{ //因为空值的情况js进行校验了
			//do nothing 
		}
		return null;
	
	
	}
	@RequestMapping(value = "/weChatLogin", method = RequestMethod.GET)
	public ModelAndView weChatLogin(HttpServletRequest request,
			HttpServletResponse response, HttpSession httpSession) {
		String code=request.getParameter("code");
		String state=request.getParameter("state");
		if(code!=null){
			try {
				WxMpOAuth2AccessToken accessToken=wxMpServiceImpl.oauth2getAccessToken(code);
				WxMpUser wxMpUser = wxMpServiceImpl.oauth2getUserInfo(accessToken, null);
				UserModel model = userService.queryByWeid(wxMpUser.getOpenId());
				System.out.println(wxMpUser.getOpenId());
				System.out.println(state);
				if(model!=null){
					Map<String, Object> data = new HashMap<String, Object>();
					data.put("status", 1);
					data.put("user", model);
					return new ModelAndView("page/user_profile", data);
				}else if(true){//该用户为新用户，跳转到注册页面，并传递openId到注册页面
					Map<String, Object> data = new HashMap<String, Object>();
					UserModel model1 =new UserModel();
					model1.setWechatOpenId(wxMpUser.getOpenId());
					data.put("status", 1);
					data.put("user", model1);
					return new ModelAndView("page/user_profile", data);
				}
				
			} catch (WxErrorException e) {
				System.out.println(e.getMessage());
			}
		}else{
			
		}
	
		return new ModelAndView("page/login",null);
	}
}
